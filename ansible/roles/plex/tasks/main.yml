---
- name: Install Plex Media Server via Homebrew Cask
  community.general.homebrew_cask:
    name: plex-media-server
    state: present
  notify: Restart Plex Media Server

- name: Stop Plex Media Server if running
  ansible.builtin.shell: osascript -e 'quit app "Plex Media Server"' || true
  args:
    executable: /bin/bash
  changed_when: false

- name: Create custom Plex Media Server data directory
  ansible.builtin.file:
    path: "{{ plex_data_dir }}"
    state: directory
    owner: "{{ plex_user }}"
    group: "{{ plex_group }}"

- name: Check if default Plex data directory exists for 'ansible' user
  ansible.builtin.stat:
    path: "/Users/ansible/Library/Application Support/Plex Media Server"
  register: plex_default_data_dir_stat

- name: Move existing Plex Media Server data to custom directory (if any)
  ansible.builtin.command: mv "/Users/ansible/Library/Application Support/Plex Media Server" "{{ plex_data_dir }}"
  args:
    creates: "{{ plex_data_dir }}/Plex Media Server"
  when: plex_default_data_dir_stat.stat.exists and not (plex_data_dir + '/Plex Media Server') is exists

- name: Create symbolic link for Plex Media Server data directory
  ansible.builtin.file:
    src: "{{ plex_data_dir }}"
    dest: "/Users/ansible/Library/Application Support/Plex Media Server"
    state: link
    force: yes
    owner: "{{ plex_user }}"
    group: "{{ plex_group }}"

- name: Create launchd plist for Plex Media Server
  ansible.builtin.copy:
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>Label</key>
          <string>com.plexapp.mediaserver</string>
          <key>ProgramArguments</key>
          <array>
              <string>/Applications/Plex Media Server.app/Contents/MacOS/Plex Media Server</string>
          </array>
          <key>UserName</key>
          <string>{{ plex_user }}</string>
          <key>GroupName</key>
          <string>{{ plex_group }}</string>
          <key>RunAtLoad</key>
          <true/>
          <key>KeepAlive</key>
          <true/>
          <key>StandardOutPath</key>
          <string>/tmp/com.plexapp.mediaserver.stdout</string>
          <key>StandardErrorPath</key>
          <string>/tmp/com.plexapp.mediaserver.stderr</string>
      </dict>
      </plist>
    dest: /Library/LaunchDaemons/com.plexapp.mediaserver.plist
    owner: root
    group: wheel
    mode: '0644'
  notify: Restart Plex Media Server

- name: Load launchd plist for Plex Media Server
  ansible.builtin.shell: launchctl load /Library/LaunchDaemons/com.plexapp.mediaserver.plist
  args:
    executable: /bin/bash
  changed_when: false

- name: Ensure Plex Media Server is running
  ansible.builtin.shell: launchctl list | grep com.plexapp.mediaserver && pgrep "Plex Media Server" || open -a "Plex Media Server"
  args:
    executable: /bin/bash
  changed_when: false
  # This task attempts to ensure Plex is running.
  # It checks if the launchd service is loaded and if the process is running.
  # If not, it tries to open the application.
  # Note: In a truly headless environment, 'open -a' might require a login session.

- name: Placeholder for media file permissions
  ansible.builtin.debug:
    msg: "Remember to set appropriate read/execute permissions for your media directories for the 'ansible' user."
